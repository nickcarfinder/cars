<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблиця автомобілів Mobile.de</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .controls {
            padding: 15px 20px;
            background-color: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .save-btn { background: #27ae60; color: white; }
        .save-btn:hover { background: #219a52; }
        .clear-btn { background: #e74c3c; color: white; }
        .clear-btn:hover { background: #c0392b; }
        .add-btn { background: #3498db; color: white; }
        .add-btn:hover { background: #2980b9; }
        .cancel-btn { background: #95a5a6; color: white; }
        .cancel-btn:hover { background: #7f8c8d; }
        .compare-btn { background: #9b59b6; color: white; }
        .compare-btn:hover { background: #8e44ad; }
        
        .info-text {
            margin-left: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .add-car-form {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            border: 2px dashed #bdc3c7;
            display: none;
        }
        .add-car-form.show {
            display: block;
        }
        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Порівняння авто */
        .comparison-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        .comparison-modal.show {
            display: block;
        }
        .comparison-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 1200px;
            border-radius: 10px;
            position: relative;
        }
        .comparison-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .comparison-close:hover {
            color: #2c3e50;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparison-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
        }
        .comparison-table td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top;
        }
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .comparison-highlight {
            background: #f1c40f !important;
            font-weight: bold;
        }
        
        /* Чекбокси для вибору */
        .select-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        /* Темплейти коментарів */
        .comment-templates {
            position: absolute;
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            max-width: 300px;
        }
        .comment-templates.show {
            display: block;
        }
        .template-item {
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        .template-item:hover {
            background: #3498db;
            color: white;
        }
        .template-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            background: #3498db;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }
        
        /* Інструкція для букмарклета */
        .bookmarklet-info {
            background: #e8f4f8;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border: 2px dashed #3498db;
            display: none;
        }
        .bookmarklet-info.show {
            display: block;
        }
        .bookmarklet-link {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            margin: 10px 0;
        }
        .bookmarklet-info pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            overflow-x: auto;
            position: relative;
            margin: 10px 0;
        }
        .copy-code-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #3498db;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }
        .copy-code-btn:hover {
            background: #2980b9;
        }
        
        /* Paste hint */
        .paste-hint {
            position: absolute;
            background: #2ecc71;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        th {
            background-color: #34495e;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #2c3e50;
            font-size: 13px;
            white-space: nowrap;
        }
        th:first-child { width: 30px; } /* Checkbox */
        th:nth-child(2) { width: 50px; } /* № */
        th:nth-child(3) { width: 200px; } /* Марка/Модель */
        th:nth-child(4) { width: 120px; } /* Тип двигуна */
        th:nth-child(5) { width: 100px; } /* Пробіг */
        th:nth-child(6) { width: 90px; } /* Ціна */
        th:nth-child(7) { width: 180px; } /* Особливості */
        th:nth-child(8) { width: 160px; } /* Оцінка */
        th:nth-child(9) { width: 250px; } /* Коментарі */
        th:nth-child(10) { width: 120px; } /* Посилання */
        th:nth-child(11) { width: 60px; } /* Дії */
        td {
            padding: 8px 6px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
            text-align: center;
        }
        td:first-child {
            padding: 0;
        }
        td:nth-child(2) { 
            font-weight: bold; 
            color: #7f8c8d; 
            font-size: 14px;
        }
        td:nth-child(3), td:nth-child(7) { 
            text-align: left; 
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e8f4f8;
            transition: background-color 0.3s ease;
        }
        .link-cell {
            text-align: center;
            vertical-align: middle;
            padding: 5px !important;
        }
        .link-cell a {
            color: #3498db;
            text-decoration: none;
            font-size: 12px;
            padding: 4px 8px;
            border: 1px solid #3498db;
            border-radius: 4px;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .link-cell a:hover {
            background: #3498db;
            color: white;
            text-decoration: none;
        }
        .editable-input {
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            padding: 6px 8px;
            font-family: inherit;
            font-size: 13px;
            border-radius: 4px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            text-align: center;
        }
        .editable-input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }
        .brand-model-input {
            font-weight: 600;
            color: #2c3e50;
            text-align: left;
            font-size: 14px;
        }
        .features-input {
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
            text-align: left;
        }
        .mileage-input {
            font-size: 13px;
            color: #2980b9;
            font-weight: 500;
        }
        .price-input {
            color: #27ae60;
            font-weight: 600;
            font-size: 14px;
        }
        .rating-cell {
            text-align: center;
            vertical-align: middle;
            padding: 5px !important;
        }
        .rating-buttons {
            display: flex;
            gap: 2px;
            justify-content: center;
            margin-bottom: 4px;
            flex-wrap: nowrap;
        }
        .rating-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .priority-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }
        .priority-btn:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
            transform: scale(1.1);
        }
        .priority-btn.active {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            box-shadow: 0 0 15px rgba(142, 68, 173, 0.8);
            animation: pulse 2s infinite;
        }
        .interesting-btn {
            background: #27ae60;
            color: white;
        }
        .interesting-btn:hover {
            background: #219a52;
            transform: scale(1.1);
        }
        .interesting-btn.active {
            background: #16a085;
            box-shadow: 0 0 10px rgba(22, 160, 133, 0.5);
        }
        .not-interesting-btn {
            background: #95a5a6;
            color: white;
        }
        .not-interesting-btn:hover {
            background: #7f8c8d;
            transform: scale(1.1);
        }
        .not-interesting-btn.active {
            background: #34495e;
            box-shadow: 0 0 10px rgba(52, 73, 94, 0.5);
        }
        .status-priority {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .status-interesting {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status-not-interesting {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        .status-neutral {
            background: #f8f9fa;
            color: #7f8c8d;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .comment-cell {
            text-align: left;
            vertical-align: middle;
            padding: 5px !important;
            position: relative;
        }
        .comment-input {
            width: 100%;
            min-height: 50px;
            max-height: 80px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 6px 8px;
            font-family: inherit;
            font-size: 12px;
            resize: vertical;
            box-sizing: border-box;
        }
        .comment-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        .status-indicator {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 8px;
            font-weight: bold;
            display: block;
            text-align: center;
            margin: 0 auto;
            max-width: 120px;
        }
        .status-liked {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status-disliked {
            background: #fadbd8;
            color: #e74c3c;
        }
        .actions-cell {
            text-align: center;
            vertical-align: middle;
            padding: 5px !important;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .stats-panel {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #2c3e50;
        }
        .stat-number {
            font-weight: bold;
            font-size: 18px;
        }
        
        @media (max-width: 1600px) {
            .container {
                margin: 10px;
                overflow-x: auto;
            }
            table {
                min-width: 1400px;
            }
        }
        @media (max-width: 768px) {
            .comment-input {
                min-height: 40px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .info-text {
                margin-left: 0;
                margin-top: 10px;
            }
            .rating-btn {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
            th, td {
                padding: 4px 2px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Таблиця автомобілів Mobile.de</h1>
            <p>Хмарна синхронізація через Firebase</p>
        </div>
        
        <div class="sync-status" id="syncStatus" style="padding: 10px 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; text-align: center; font-size: 14px;">
            <span style="color: #ffc107;">🔄 Підключення до Firebase...</span>
        </div>
        
        <div class="controls">
            <button class="btn save-btn" onclick="forceSyncToCloud()">☁️ Синхронізувати</button>
            <button class="btn clear-btn" onclick="clearAllData()">🗑️ Очистити все</button>
            <button class="btn add-btn" onclick="toggleAddForm()">➕ Додати авто</button>
            <button class="btn compare-btn" onclick="showComparison()" id="compareBtn">🔍 Порівняти (0)</button>
            <button class="btn" style="background: #8e44ad; color: white;" onclick="sortByPriority(event)">🏆 Сортувати за пріоритетом</button>
            <button class="btn" style="background: #17a2b8; color: white;" onclick="resetToDefaults(event)">🔄 Відновити початкові авто</button>
            <button class="btn" style="background: #f39c12; color: white;" onclick="toggleBookmarkletInfo()">📌 Букмарклет</button>
            <span class="info-text">
                ☁️ Автоматична синхронізація з Firebase + localStorage backup
            </span>
        </div>
        
        <div class="bookmarklet-info" id="bookmarkletInfo">
            <h3>📌 Інструкція для копіювання даних з Mobile.de</h3>
            
            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>🌐 Для Arc Browser:</strong> Використовуйте Arc Boost або метод через консоль (див. нижче)
            </div>
            
            <h4>Варіант 1: Arc Boost (рекомендовано для Arc)</h4>
            <ol>
                <li>Натисніть Cmd+T і введіть "boost"</li>
                <li>Створіть новий Boost для сайту mobile.de</li>
                <li>Виберіть "Inject JS" і вставте код з інструкції</li>
                <li>На сторінках mobile.de з'явиться кнопка "📋 Копіювати для таблиці"</li>
            </ol>
            
            <h4>Варіант 2: Через консоль (швидкий спосіб)</h4>
            <ol>
                <li>Відкрийте оголошення на mobile.de</li>
                <li>Відкрийте консоль (Cmd+Option+I)</li>
                <li>Вставте цей код і натисніть Enter:</li>
            </ol>
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto; position: relative;">
<button class="copy-code-btn" onclick="copyConsoleCode(event)" style="position: absolute; top: 5px; right: 5px; background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">📋 Копіювати</button>(function(){var d={};d.brand=document.querySelector('h1')?.textContent?.trim()||'';d.price=document.querySelector('[data-testid="prime-price"]')?.textContent?.trim()||'';d.mileage=Array.from(document.querySelectorAll('.u-block')).find(el=>el.textContent.includes('km'))?.textContent?.trim()||'';var f=[];document.querySelectorAll('[data-testid="basic-details-item"]').forEach(el=>{var t=el.textContent.trim();if(t&&!t.includes('km')&&!t.includes('€'))f.push(t);});d.features=f.slice(0,3).join(', ');d.url=window.location.href;var o='🚗 '+d.brand+'\n💶 '+d.price+'\n📏 '+d.mileage+'\n✨ '+d.features+'\n🔗 '+d.url;navigator.clipboard.writeText(o);console.log('✅ Скопійовано!\n\n'+o);})();</pre>
            
            <h4>Варіант 3: Букмарклет (для інших браузерів)</h4>
            <p>Перетягніть цю кнопку в панель закладок:</p>
            <a href="javascript:(function(){var data={};var title=document.querySelector('h1.h2')?.textContent?.trim()||'';data.brand=title;var priceEl=document.querySelector('[data-testid=&quot;prime-price&quot;]');data.price=priceEl?priceEl.textContent.trim():'';var mileageEl=Array.from(document.querySelectorAll('[data-testid=&quot;mileage&quot;]')).find(el=>el.textContent.includes('km'));data.mileage=mileageEl?mileageEl.textContent.trim():'';var features=[];document.querySelectorAll('[data-testid=&quot;basic-details-item&quot;]').forEach(el=>{var text=el.textContent.trim();if(text&&!text.includes('km')&&!text.includes('€'))features.push(text);});data.features=features.slice(0,3).join(', ');data.url=window.location.href;data.type='Плагін-гібрид';var output='🚗 '+data.brand+'\n';output+='💶 '+data.price+'\n';output+='📏 '+data.mileage+'\n';output+='✨ '+data.features+'\n';output+='🔗 '+data.url;navigator.clipboard.writeText(output).then(()=>{alert('✅ Дані скопійовані!\n\n'+output+'\n\nТепер вставте їх у форму додавання авто.');}).catch(()=>{prompt('Скопіюйте ці дані:',output);});})();" class="bookmarklet-link">
                📋 Mobile.de Копіювач
            </a>
            
            <h4>Як використовувати скопійовані дані:</h4>
            <ol>
                <li>Натисніть "➕ Додати авто"</li>
                <li>Вставте дані в поле "Марка/Модель" (Cmd+V)</li>
                <li>Всі поля заповняться автоматично!</li>
            </ol>
            
            <p style="color: #27ae60;"><strong>💡 Підказка:</strong> Після копіювання даних можете також натиснути кнопку внизу форми для швидкого заповнення</p>
        </div>
        
        <div class="add-car-form" id="addCarForm">
            <h3>➕ Додати новий автомобіль</h3>
            <div id="pasteHint" class="paste-hint">💡 Вставте дані з букмарклета сюди!</div>
            <p style="font-size: 12px; color: #7f8c8d; margin: 0 0 10px 0;">
                💡 Підказка: Скористайтесь букмарклетом на сторінці mobile.de або просто вставте посилання/дані в перше поле
            </p>
            <div class="form-group">
                <input type="text" id="newCarBrand" class="form-input" placeholder="Марка/Модель або вставте дані з букмарклета" required>
                <input type="text" id="newCarType" class="form-input" placeholder="Тип двигуна" value="Плагін-гібрид">
            </div>
            <div class="form-group">
                <input type="text" id="newCarMileage" class="form-input" placeholder="Пробіг (км)">
                <input type="text" id="newCarPrice" class="form-input" placeholder="Ціна (€)">
            </div>
            <div class="form-group">
                <input type="text" id="newCarFeatures" class="form-input" placeholder="Особливості">
                <input type="url" id="newCarUrl" class="form-input" placeholder="Посилання на оголошення" required>
            </div>
            <div class="form-actions">
                <button class="btn add-btn" onclick="addNewCar()">✅ Додати</button>
                <button class="btn cancel-btn" onclick="toggleAddForm()">❌ Скасувати</button>
                <button class="btn" style="background: #f39c12; color: white;" onclick="window.quickFillFromClipboard && window.quickFillFromClipboard()" title="Заповнити з буфера обміну">📋 Вставити з буфера</button>
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>✓</th>
                    <th>№</th>
                    <th>Марка/Модель</th>
                    <th>Тип двигуна</th>
                    <th>Пробіг</th>
                    <th>Ціна</th>
                    <th>Особливості</th>
                    <th>Оцінка</th>
                    <th>Коментарі</th>
                    <th>Посилання</th>
                    <th>Дії</th>
                </tr>
            </thead>
            <tbody id="carTable">
            </tbody>
        </table>
        
        <div class="stats-panel" id="statsPanel">
            <div class="stat-item">
                <span>🚗 Всього:</span>
                <span class="stat-number" id="statTotal">0</span>
            </div>
            <div class="stat-item">
                <span>🏆 Топ пріоритет:</span>
                <span class="stat-number" id="statPriority" style="color: #9b59b6;">0</span>
            </div>
            <div class="stat-item">
                <span>👍 Цікаво:</span>
                <span class="stat-number" id="statInteresting" style="color: #27ae60;">0</span>
            </div>
            <div class="stat-item">
                <span>👎 Не цікаво:</span>
                <span class="stat-number" id="statNotInteresting" style="color: #7f8c8d;">0</span>
            </div>
            <div class="stat-item">
                <span>🤔 Не оцінено:</span>
                <span class="stat-number" id="statNeutral">0</span>
            </div>
        </div>
    </div>

    <!-- Модальне вікно порівняння -->
    <div class="comparison-modal" id="comparisonModal">
        <div class="comparison-content">
            <span class="comparison-close" onclick="closeComparison()">&times;</span>
            <h2>🔍 Порівняння обраних автомобілів</h2>
            <div id="comparisonTableContainer"></div>
        </div>
    </div>

    <!-- Темплейти коментарів -->
    <div class="comment-templates" id="commentTemplates">
        <div class="template-item" onclick="applyTemplate('Гарне співвідношення ціна/якість')">💰 Гарне співвідношення ціна/якість</div>
        <div class="template-item" onclick="applyTemplate('Занадто великий пробіг')">📏 Занадто великий пробіг</div>
        <div class="template-item" onclick="applyTemplate('Ідеальна комплектація')">✨ Ідеальна комплектація</div>
        <div class="template-item" onclick="applyTemplate('Потрібна додаткова перевірка')">🔍 Потрібна додаткова перевірка</div>
        <div class="template-item" onclick="applyTemplate('Завищена ціна')">💸 Завищена ціна</div>
        <div class="template-item" onclick="applyTemplate('Підходить для сім\'ї')">👨‍👩‍👧‍👦 Підходить для сім'ї</div>
        <div class="template-item" onclick="applyTemplate('Економічний варіант')">⚡ Економічний варіант</div>
        <div class="template-item" onclick="applyTemplate('Преміум сегмент')">🏆 Преміум сегмент</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase конфігурація
        const firebaseConfig = {
            apiKey: "AIzaSyDl_ZYOx4rvJqYhz5a3rjFCa0XU0Elx4tA",
            authDomain: "car-table-app.firebaseapp.com",
            projectId: "car-table-app",
            storageBucket: "car-table-app.firebasestorage.app",
            messagingSenderId: "1089172844020",
            appId: "1:1089172844020:web:77e5936de00905c1d5dda1"
        };

        // Ініціалізація Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Зробити Firebase доступним глобально
        window.firebaseDb = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseOnSnapshot = onSnapshot;
        window.isFirebaseReady = true;

        // Оновити статус
        const statusElement = document.getElementById('syncStatus');
        if (statusElement) {
            statusElement.innerHTML = '<span style="color: #28a745;">✅ Firebase підключено</span>';
        }

        console.log('Firebase ініціалізовано успішно');
    </script>

    <script>
        // Початкові дані автомобілів
        let carsData = [
            {
                id: "426743473",
                brand: "Mercedes-Benz GLC 300",
                type: "Гібрид",
                mileage: "85,000 км",
                price: "42,500 €",
                features: "AHK, Камера, Панорама",
                url: "https://suchen.mobile.de/auto-inserat/mercedes-benz-glc-300-ahk-kamera-pano/426743473.html"
            },
            {
                id: "418664792",
                brand: "Mercedes-Benz GLE 350",
                type: "Плагін-гібрид",
                mileage: "45,000 км",
                price: "38,900 €",
                features: "Топ категорії",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=418664792"
            },
            {
                id: "423350671",
                brand: "Mercedes-Benz C 300",
                type: "Плагін-гібрид",
                mileage: "62,000 км",
                price: "35,500 €",
                features: "AMG пакет",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=423350671"
            },
            {
                id: "420538971",
                brand: "Mercedes-Benz E 300",
                type: "Плагін-гібрид",
                mileage: "78,000 км",
                price: "43,200 €",
                features: "Повна комплектація",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=420538971"
            },
            {
                id: "427620635",
                brand: "Mercedes-Benz GLC 300",
                type: "Плагін-гібрид",
                mileage: "55,000 км",
                price: "39,800 €",
                features: "4MATIC, Premium",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=427620635"
            },
            {
                id: "411812367",
                brand: "Mercedes-Benz S 400",
                type: "Плагін-гібрид",
                mileage: "92,000 км",
                price: "52,000 €",
                features: "Eye Catcher, Люкс",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=411812367"
            },
            {
                id: "423733871",
                brand: "Mercedes-Benz A 250",
                type: "Плагін-гібрид",
                mileage: "35,000 км",
                price: "32,500 €",
                features: "AMG Line, Компакт",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=423733871"
            },
            {
                id: "414802954",
                brand: "Mercedes-Benz CLA 250",
                type: "Плагін-гібрид",
                mileage: "48,000 км",
                price: "36,900 €",
                features: "Купе стиль",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=414802954"
            },
            {
                id: "425386910",
                brand: "Mercedes-Benz GLA 250",
                type: "Плагін-гібрид",
                mileage: "28,000 км",
                price: "37,500 €",
                features: "Компактний SUV",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=425386910"
            },
            {
                id: "422158453",
                brand: "Mercedes-Benz GLB 250",
                type: "Плагін-гібрид",
                mileage: "41,000 км",
                price: "40,200 €",
                features: "7 місць, Сімейний",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=422158453"
            },
            {
                id: "424538448",
                brand: "BMW X5 xDrive45e",
                type: "Плагін-гібрид",
                mileage: "65,000 км",
                price: "44,800 €",
                features: "Універсал, від 2022 р.",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=424538448"
            },
            {
                id: "421648521",
                brand: "BMW 330e",
                type: "Плагін-гібрид",
                mileage: "52,000 км",
                price: "38,500 €",
                features: "Універсал, Спорт пакет",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=421648521"
            },
            {
                id: "414011356",
                brand: "Audi Q5 55 TFSI e",
                type: "Плагін-гібрид",
                mileage: "38,000 км",
                price: "42,900 €",
                features: "Quattro, Топ категорії",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=414011356"
            },
            {
                id: "415765423",
                brand: "Volvo XC60 T8",
                type: "Плагін-гібрид",
                mileage: "45,000 км",
                price: "39,500 €",
                features: "від 2020 р., AWD",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=415765423"
            },
            {
                id: "427272252",
                brand: "Porsche Cayenne E-Hybrid",
                type: "Плагін-гібрид",
                mileage: "58,000 км",
                price: "48,500 €",
                features: "Спорт хромо, Преміум",
                url: "https://suchen.mobile.de/fahrzeuge/details.html?id=427272252"
            }
        ];

        // Змінні для збереження оцінок та коментарів
        let carRatings = {};
        let carComments = {};
        let selectedCars = new Set();
        let isFirebaseReady = false;
        let currentCommentInput = null;

        // Чекаємо готовність Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.isFirebaseReady && window.firebaseDb) {
                        isFirebaseReady = true;
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Firebase синхронізація
        async function syncToFirebase() {
            if (!isFirebaseReady) return false;
            
            try {
                const dataToSync = {
                    carsData: carsData,
                    carRatings: carRatings,
                    carComments: carComments,
                    lastUpdated: new Date().toISOString()
                };

                const docRef = window.firebaseDoc(window.firebaseDb, 'carTable', 'data');
                await window.firebaseSetDoc(docRef, dataToSync);
                
                const statusElement = document.getElementById('syncStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #28a745;">✅ Синхронізовано з хмарою</span>';
                }
                
                console.log('Дані синхронізовані з Firebase');
                return true;
            } catch (error) {
                console.error('Помилка синхронізації з Firebase:', error);
                const statusElement = document.getElementById('syncStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #dc3545;">❌ Помилка синхронізації</span>';
                }
                return false;
            }
        }

        async function loadFromFirebase() {
            if (!isFirebaseReady) {
                console.log('Firebase не готовий');
                return false;
            }
            
            try {
                const docRef = window.firebaseDoc(window.firebaseDb, 'carTable', 'data');
                const docSnap = await window.firebaseGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Завантажуємо тільки якщо дані не порожні
                    if (data.carsData && data.carsData.length > 0) {
                        carsData = data.carsData;
                        console.log('Завантажені автомобілі з Firebase:', carsData.length);
                    }
                    if (data.carRatings) {
                        carRatings = data.carRatings;
                        console.log('Завантажені рейтинги з Firebase:', Object.keys(carRatings).length);
                    }
                    if (data.carComments) {
                        carComments = data.carComments;
                        console.log('Завантажені коментарі з Firebase:', Object.keys(carComments).length);
                    }
                    
                    console.log('Дані успішно завантажені з Firebase');
                    return true;
                } else {
                    console.log('Документ не існує в Firebase, використовуємо початкові дані');
                    // Зберігаємо початкові дані в Firebase
                    await syncToFirebase();
                }
            } catch (error) {
                console.error('Помилка завантаження з Firebase:', error);
            }
            return false;
        }

        // Real-time синхронізація
        function setupRealtimeSync() {
            if (!isFirebaseReady) return;
            
            try {
                const docRef = window.firebaseDoc(window.firebaseDb, 'carTable', 'data');
                window.firebaseOnSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.carsData) carsData = data.carsData;
                        if (data.carRatings) carRatings = data.carRatings;
                        if (data.carComments) carComments = data.carComments;
                        
                        generateTable();
                        updateStats();
                        
                        const statusElement = document.getElementById('syncStatus');
                        if (statusElement) {
                            statusElement.innerHTML = '<span style="color: #17a2b8;">🔄 Оновлено з хмари</span>';
                            setTimeout(() => {
                                statusElement.innerHTML = '<span style="color: #28a745;">✅ Синхронізовано</span>';
                            }, 2000);
                        }
                    }
                });
            } catch (error) {
                console.error('Помилка real-time синхронізації:', error);
            }
        }

        // Функція завантаження збережених даних
        async function loadSavedData() {
            console.log('Початок завантаження даних...');
            
            // Спочатку завантажуємо з localStorage (швидко)
            try {
                const savedRatings = localStorage.getItem('carRatings');
                const savedComments = localStorage.getItem('carComments');
                const savedCars = localStorage.getItem('carsData');
                
                if (savedRatings) {
                    carRatings = JSON.parse(savedRatings);
                    console.log('Завантажені рейтинги з localStorage:', Object.keys(carRatings).length);
                }
                if (savedComments) {
                    carComments = JSON.parse(savedComments);
                    console.log('Завантажені коментарі з localStorage:', Object.keys(carComments).length);
                }
                if (savedCars && savedCars !== '[]') {
                    carsData = JSON.parse(savedCars);
                    console.log('Завантажені автомобілі з localStorage:', carsData.length);
                } else {
                    console.log('Використовуємо початкові дані автомобілів');
                }
                
            } catch (error) {
                console.error('Помилка завантаження з localStorage:', error);
            }

            // Потім чекаємо Firebase і завантажуємо з хмари
            await waitForFirebase();
            const firebaseLoaded = await loadFromFirebase();
            
            if (firebaseLoaded) {
                setupRealtimeSync();
                console.log('Firebase real-time синхронізація налаштована');
            } else {
                console.log('Firebase не завантажився, працюємо локально');
            }
        }

        // Автозбереження (подвійне: localStorage + Firebase)
        async function autoSave() {
            // Завжди зберігаємо в localStorage (швидко)
            try {
                localStorage.setItem('carRatings', JSON.stringify(carRatings));
                localStorage.setItem('carComments', JSON.stringify(carComments));
                localStorage.setItem('carsData', JSON.stringify(carsData));
            } catch (error) {
                console.error('Помилка localStorage:', error);
            }

            // І в Firebase якщо доступний
            if (isFirebaseReady) {
                await syncToFirebase();
            }
        }

        // Примусова синхронізація
        async function forceSyncToCloud() {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.innerHTML = '<span style="color: #ffc107;">🔄 Синхронізація...</span>';
            }
            
            await autoSave();
        }

        // Очистка всіх даних
        async function clearAllData() {
            if (confirm('Ви впевнені, що хочете очистити всі дані (авто, оцінки, коментарі)?')) {
                carRatings = {};
                carComments = {};
                localStorage.removeItem('carRatings');
                localStorage.removeItem('carComments');
                localStorage.removeItem('carsData');
                
                // Очистити Firebase
                if (isFirebaseReady) {
                    try {
                        const docRef = window.firebaseDoc(window.firebaseDb, 'carTable', 'data');
                        await window.firebaseSetDoc(docRef, {
                            carsData: [],
                            carRatings: {},
                            carComments: {},
                            lastUpdated: new Date().toISOString()
                        });
                    } catch (error) {
                        console.error('Помилка очищення Firebase:', error);
                    }
                }
                
                location.reload();
            }
        }

        // Показати/приховати інструкцію букмарклета
        function toggleBookmarkletInfo() {
            const info = document.getElementById('bookmarkletInfo');
            if (info) {
                info.classList.toggle('show');
            }
        }

        // Показати/приховати форму додавання
        function toggleAddForm() {
            const form = document.getElementById('addCarForm');
            if (form) {
                form.classList.toggle('show');
                
                if (form.classList.contains('show')) {
                    const brandInput = document.getElementById('newCarBrand');
                    if (brandInput) {
                        brandInput.focus();
                        // Показати підказку
                        const hint = document.getElementById('pasteHint');
                        if (hint) {
                            hint.style.display = 'block';
                            hint.style.left = brandInput.offsetLeft + 'px';
                            hint.style.top = (brandInput.offsetTop - 35) + 'px';
                            setTimeout(() => {
                                hint.style.display = 'none';
                            }, 3000);
                        }
                    }
                } else {
                    // Очистити форму
                    const inputs = ['newCarBrand', 'newCarMileage', 'newCarPrice', 'newCarFeatures', 'newCarUrl'];
                    inputs.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) element.value = '';
                    });
                    const typeInput = document.getElementById('newCarType');
                    if (typeInput) typeInput.value = 'Плагін-гібрид';
                }
            }
        }

        // Розумна вставка даних
        function smartPasteHandler() {
            const brandInput = document.getElementById('newCarBrand');
            const priceInput = document.getElementById('newCarPrice');
            const mileageInput = document.getElementById('newCarMileage');
            const featuresInput = document.getElementById('newCarFeatures');
            const urlInput = document.getElementById('newCarUrl');
            
            // Слухаємо подію вставки на полі бренду
            brandInput?.addEventListener('paste', async (e) => {
                e.preventDefault();
                const text = e.clipboardData.getData('text');
                
                // Шукаємо патерни в тексті
                const lines = text.split('\n');
                let foundData = false;
                
                lines.forEach(line => {
                    if (line.includes('🚗')) {
                        brandInput.value = line.replace('🚗', '').trim();
                        foundData = true;
                    } else if (line.includes('💶')) {
                        priceInput.value = line.replace('💶', '').trim();
                        foundData = true;
                    } else if (line.includes('📏')) {
                        mileageInput.value = line.replace('📏', '').trim();
                        foundData = true;
                    } else if (line.includes('✨')) {
                        featuresInput.value = line.replace('✨', '').trim();
                        foundData = true;
                    } else if (line.includes('🔗') || line.includes('mobile.de')) {
                        urlInput.value = line.replace('🔗', '').trim();
                        foundData = true;
                    }
                });
                
                // Якщо знайдені дані з букмарклета
                if (foundData) {
                    // Анімація успіху
                    brandInput.style.borderColor = '#27ae60';
                    brandInput.style.boxShadow = '0 0 10px rgba(39, 174, 96, 0.5)';
                    setTimeout(() => {
                        brandInput.style.borderColor = '';
                        brandInput.style.boxShadow = '';
                    }, 2000);
                } else if (text.includes('mobile.de')) {
                    // Якщо це просто URL
                    urlInput.value = text.trim();
                    brandInput.focus();
                    alert('📌 URL вставлено! Заповніть інші поля вручну або скористайтесь букмарклетом на сторінці оголошення.');
                } else {
                    // Якщо це звичайний текст
                    brandInput.value = text.trim();
                }
            });
            
            // Додаємо глобальну функцію для швидкого заповнення (для Arc)
            window.quickFillFromClipboard = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    const event = new ClipboardEvent('paste', {
                        clipboardData: new DataTransfer()
                    });
                    Object.defineProperty(event, 'clipboardData', {
                        value: {
                            getData: () => text
                        }
                    });
                    brandInput.dispatchEvent(event);
                } catch (err) {
                    console.error('Помилка читання буфера:', err);
                }
            };
        }

        // Додати новий автомобіль
        async function addNewCar() {
            const brand = document.getElementById('newCarBrand')?.value?.trim() || '';
            const type = document.getElementById('newCarType')?.value?.trim() || 'Плагін-гібрид';
            const mileage = document.getElementById('newCarMileage')?.value?.trim() || '';
            const price = document.getElementById('newCarPrice')?.value?.trim() || '';
            const features = document.getElementById('newCarFeatures')?.value?.trim() || '';
            const url = document.getElementById('newCarUrl')?.value?.trim() || '';

            if (!brand || !url) {
                alert('Будь ласка, заповніть обов\'язкові поля: Марка/Модель та Посилання');
                return;
            }

            // Генеруємо унікальний ID
            const newId = 'manual_' + Date.now();

            // Додати новий автомобіль
            const newCar = {
                id: newId,
                brand: brand,
                type: type,
                mileage: mileage,
                price: price,
                features: features,
                url: url
            };

            carsData.push(newCar);
            await autoSave();
            generateTable();
            updateStats();
            toggleAddForm();
        }

        // Додати авто з розширення Chrome
        async function addCarFromExtension(car) {
            if (!car.id) {
                car.id = 'ext_' + Date.now();
            }
            carsData.push(car);
            await autoSave();
            generateTable();
            updateStats();
        }

        // Видалити автомобіль
        async function deleteCar(carId) {
            if (confirm('Ви впевнені, що хочете видалити цей автомобіль?')) {
                carsData = carsData.filter(car => car.id !== carId);
                delete carRatings[carId];
                delete carComments[carId];
                selectedCars.delete(carId);
                await autoSave();
                generateTable();
                updateStats();
                updateCompareButton();
            }
        }

        // Оновити дані автомобіля
        async function updateCarData(carId, field, value) {
            const car = carsData.find(c => c.id === carId);
            if (car) {
                car[field] = value;
                await autoSave();
            }
        }

        // Оцінка автомобіля
        async function rateCar(carId, rating) {
            // Якщо натиснули ту ж кнопку - скидаємо оцінку
            if (carRatings[carId] === rating) {
                delete carRatings[carId];
            } else {
                carRatings[carId] = rating;
            }
            
            await autoSave();
            updateRatingDisplay(carId);
            updateStats();
        }

        // Оновлення коментаря з затримкою
        let commentTimeouts = {};
        
        function updateComment(carId, comment) {
            // Очищуємо попередній таймер для цього авто
            if (commentTimeouts[carId]) {
                clearTimeout(commentTimeouts[carId]);
            }
            
            // Встановлюємо новий таймер з затримкою
            commentTimeouts[carId] = setTimeout(async () => {
                carComments[carId] = comment;
                await autoSave();
            }, 1000); // Зберігаємо через 1 секунду після останнього введення
        }

        // Темплейти коментарів
        function showCommentTemplates(textarea) {
            currentCommentInput = textarea;
            const templates = document.getElementById('commentTemplates');
            const rect = textarea.getBoundingClientRect();
            templates.style.left = rect.left + 'px';
            templates.style.top = (rect.bottom + 5) + 'px';
            templates.classList.add('show');
        }

        function hideCommentTemplates() {
            const templates = document.getElementById('commentTemplates');
            templates.classList.remove('show');
        }

        function applyTemplate(template) {
            if (currentCommentInput) {
                const carId = currentCommentInput.dataset.carId;
                const currentValue = currentCommentInput.value;
                if (currentValue) {
                    currentCommentInput.value = currentValue + '\n' + template;
                } else {
                    currentCommentInput.value = template;
                }
                updateComment(carId, currentCommentInput.value);
                hideCommentTemplates();
            }
        }

        // Закрити темплейти при кліку поза ними
        document.addEventListener('click', (e) => {
            const templates = document.getElementById('commentTemplates');
            const isTextarea = e.target.classList.contains('comment-input');
            const isTemplateBtn = e.target.classList.contains('template-btn');
            const isTemplate = e.target.closest('.comment-templates');
            
            if (!isTextarea && !isTemplateBtn && !isTemplate) {
                hideCommentTemplates();
            }
        });

        // Копіювати код для консолі
        function copyConsoleCode(event) {
            const code = `(function(){var d={};d.brand=document.querySelector('h1')?.textContent?.trim()||'';d.price=document.querySelector('[data-testid="prime-price"]')?.textContent?.trim()||'';d.mileage=Array.from(document.querySelectorAll('.u-block')).find(el=>el.textContent.includes('km'))?.textContent?.trim()||'';var f=[];document.querySelectorAll('[data-testid="basic-details-item"]').forEach(el=>{var t=el.textContent.trim();if(t&&!t.includes('km')&&!t.includes('€'))f.push(t);});d.features=f.slice(0,3).join(', ');d.url=window.location.href;var o='🚗 '+d.brand+'\\n💶 '+d.price+'\\n📏 '+d.mileage+'\\n✨ '+d.features+'\\n🔗 '+d.url;navigator.clipboard.writeText(o);console.log('✅ Скопійовано!\\n\\n'+o);})();`;
            
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Скопійовано!';
                btn.style.background = '#27ae60';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#3498db';
                }, 2000);
            });
        }

        // Відновлення початкових даних
        async function resetToDefaults(event) {
            if (confirm('Відновити початкові 15 автомобілів? (Ваші додані авто будуть видалені, але оцінки та коментарі збережуться)')) {
                // Відновлюємо початковий масив автомобілів
                carsData = [
                    {
                        id: "426743473",
                        brand: "Mercedes-Benz GLC 300",
                        type: "Гібрид",
                        mileage: "85,000 км",
                        price: "42,500 €",
                        features: "AHK, Камера, Панорама",
                        url: "https://suchen.mobile.de/auto-inserat/mercedes-benz-glc-300-ahk-kamera-pano/426743473.html"
                    },
                    {
                        id: "418664792",
                        brand: "Mercedes-Benz GLE 350",
                        type: "Плагін-гібрид",
                        mileage: "45,000 км",
                        price: "38,900 €",
                        features: "Топ категорії",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=418664792"
                    },
                    {
                        id: "423350671",
                        brand: "Mercedes-Benz C 300",
                        type: "Плагін-гібрид",
                        mileage: "62,000 км",
                        price: "35,500 €",
                        features: "AMG пакет",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=423350671"
                    },
                    {
                        id: "420538971",
                        brand: "Mercedes-Benz E 300",
                        type: "Плагін-гібрид",
                        mileage: "78,000 км",
                        price: "43,200 €",
                        features: "Повна комплектація",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=420538971"
                    },
                    {
                        id: "427620635",
                        brand: "Mercedes-Benz GLC 300",
                        type: "Плагін-гібрид",
                        mileage: "55,000 км",
                        price: "39,800 €",
                        features: "4MATIC, Premium",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=427620635"
                    },
                    {
                        id: "411812367",
                        brand: "Mercedes-Benz S 400",
                        type: "Плагін-гібрид",
                        mileage: "92,000 км",
                        price: "52,000 €",
                        features: "Eye Catcher, Люкс",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=411812367"
                    },
                    {
                        id: "423733871",
                        brand: "Mercedes-Benz A 250",
                        type: "Плагін-гібрид",
                        mileage: "35,000 км",
                        price: "32,500 €",
                        features: "AMG Line, Компакт",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=423733871"
                    },
                    {
                        id: "414802954",
                        brand: "Mercedes-Benz CLA 250",
                        type: "Плагін-гібрид",
                        mileage: "48,000 км",
                        price: "36,900 €",
                        features: "Купе стиль",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=414802954"
                    },
                    {
                        id: "425386910",
                        brand: "Mercedes-Benz GLA 250",
                        type: "Плагін-гібрид",
                        mileage: "28,000 км",
                        price: "37,500 €",
                        features: "Компактний SUV",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=425386910"
                    },
                    {
                        id: "422158453",
                        brand: "Mercedes-Benz GLB 250",
                        type: "Плагін-гібрид",
                        mileage: "41,000 км",
                        price: "40,200 €",
                        features: "7 місць, Сімейний",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=422158453"
                    },
                    {
                        id: "424538448",
                        brand: "BMW X5 xDrive45e",
                        type: "Плагін-гібрид",
                        mileage: "65,000 км",
                        price: "44,800 €",
                        features: "Універсал, від 2022 р.",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=424538448"
                    },
                    {
                        id: "421648521",
                        brand: "BMW 330e",
                        type: "Плагін-гібрид",
                        mileage: "52,000 км",
                        price: "38,500 €",
                        features: "Універсал, Спорт пакет",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=421648521"
                    },
                    {
                        id: "414011356",
                        brand: "Audi Q5 55 TFSI e",
                        type: "Плагін-гібрид",
                        mileage: "38,000 км",
                        price: "42,900 €",
                        features: "Quattro, Топ категорії",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=414011356"
                    },
                    {
                        id: "415765423",
                        brand: "Volvo XC60 T8",
                        type: "Плагін-гібрид",
                        mileage: "45,000 км",
                        price: "39,500 €",
                        features: "від 2020 р., AWD",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=415765423"
                    },
                    {
                        id: "427272252",
                        brand: "Porsche Cayenne E-Hybrid",
                        type: "Плагін-гібрид",
                        mileage: "58,000 км",
                        price: "48,500 €",
                        features: "Спорт хромо, Преміум",
                        url: "https://suchen.mobile.de/fahrzeuge/details.html?id=427272252"
                    }
                ];

                await autoSave();
                generateTable();
                updateStats();
                
                // Показати повідомлення
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Відновлено!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
                
                console.log('Відновлено початкові дані, автомобілів:', carsData.length);
            }
        }

        // Сортування за пріоритетом
        async function sortByPriority(event) {
            carsData.sort((a, b) => {
                const ratingA = carRatings[a.id] || 'none';
                const ratingB = carRatings[b.id] || 'none';
                
                // Пріоритет сортування: priority > interesting > none > not-interesting
                const priorityOrder = {
                    'priority': 4,
                    'interesting': 3,
                    'none': 2,
                    'not-interesting': 1
                };
                
                return priorityOrder[ratingB] - priorityOrder[ratingA];
            });
            
            await autoSave();
            generateTable();
            
            // Показати повідомлення
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ Відсортовано!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // Обробка вибору авто для порівняння
        function toggleCarSelection(carId) {
            if (selectedCars.has(carId)) {
                selectedCars.delete(carId);
            } else {
                selectedCars.add(carId);
            }
            updateCompareButton();
        }

        function updateCompareButton() {
            const btn = document.getElementById('compareBtn');
            if (btn) {
                btn.textContent = `🔍 Порівняти (${selectedCars.size})`;
                btn.disabled = selectedCars.size < 2;
                btn.style.opacity = selectedCars.size < 2 ? '0.6' : '1';
            }
        }

        // Показати порівняння
        function showComparison() {
            if (selectedCars.size < 2) {
                alert('Оберіть принаймні 2 автомобілі для порівняння');
                return;
            }

            const modal = document.getElementById('comparisonModal');
            const container = document.getElementById('comparisonTableContainer');
            
            // Отримати обрані авто
            const selectedCarsData = carsData.filter(car => selectedCars.has(car.id));
            
            // Побудувати таблицю порівняння
            let html = '<table class="comparison-table">';
            
            // Заголовок з назвами авто
            html += '<tr><th>Параметр</th>';
            selectedCarsData.forEach(car => {
                html += `<th>${car.brand}</th>`;
            });
            html += '</tr>';
            
            // Порівняння параметрів
            const parameters = [
                { key: 'type', name: 'Тип двигуна' },
                { key: 'mileage', name: 'Пробіг' },
                { key: 'price', name: 'Ціна' },
                { key: 'features', name: 'Особливості' }
            ];
            
            parameters.forEach(param => {
                html += `<tr><td><strong>${param.name}</strong></td>`;
                selectedCarsData.forEach(car => {
                    html += `<td>${car[param.key] || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            // Оцінки
            html += '<tr><td><strong>Оцінка</strong></td>';
            selectedCarsData.forEach(car => {
                const rating = carRatings[car.id];
                let ratingText = '🤔 Не оцінено';
                let highlightClass = '';
                
                if (rating === 'priority') {
                    ratingText = '🏆 ТОП ПРІОРИТЕТ';
                    highlightClass = 'comparison-highlight';
                } else if (rating === 'interesting') {
                    ratingText = '👍 Цікаво';
                } else if (rating === 'not-interesting') {
                    ratingText = '👎 Не цікаво';
                }
                
                html += `<td class="${highlightClass}">${ratingText}</td>`;
            });
            html += '</tr>';
            
            // Коментарі
            html += '<tr><td><strong>Коментарі</strong></td>';
            selectedCarsData.forEach(car => {
                const comment = carComments[car.id] || 'Немає коментарів';
                html += `<td>${comment}</td>`;
            });
            html += '</tr>';
            
            // Посилання
            html += '<tr><td><strong>Посилання</strong></td>';
            selectedCarsData.forEach(car => {
                html += `<td><a href="${car.url}" target="_blank" style="color: #3498db;">Переглянути</a></td>`;
            });
            html += '</tr>';
            
            html += '</table>';
            
            container.innerHTML = html;
            modal.classList.add('show');
        }

        function closeComparison() {
            const modal = document.getElementById('comparisonModal');
            modal.classList.remove('show');
        }

        // Оновлення статистики
        function updateStats() {
            const total = carsData.length;
            const priority = Object.values(carRatings).filter(r => r === 'priority').length;
            const interesting = Object.values(carRatings).filter(r => r === 'interesting').length;
            const notInteresting = Object.values(carRatings).filter(r => r === 'not-interesting').length;
            const neutral = total - priority - interesting - notInteresting;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPriority').textContent = priority;
            document.getElementById('statInteresting').textContent = interesting;
            document.getElementById('statNotInteresting').textContent = notInteresting;
            document.getElementById('statNeutral').textContent = neutral;
        }

        // Оновлення відображення оцінки
        function updateRatingDisplay(carId) {
            try {
                const priorityBtn = document.querySelector('#priority-' + carId);
                const interestingBtn = document.querySelector('#interesting-' + carId);
                const notInterestingBtn = document.querySelector('#not-interesting-' + carId);
                const statusSpan = document.querySelector('#status-' + carId);
                
                if (!priorityBtn || !interestingBtn || !notInterestingBtn || !statusSpan) {
                    console.warn('Не знайдені елементи для carId:', carId);
                    return;
                }
                
                // Скидання активних станів
                priorityBtn.classList.remove('active');
                interestingBtn.classList.remove('active');
                notInterestingBtn.classList.remove('active');
                
                // Встановлення активного стану та статусу
                const rating = carRatings[carId];
                
                if (rating === 'priority') {
                    priorityBtn.classList.add('active');
                    statusSpan.textContent = '🏆 ТОП ПРІОРИТЕТ';
                    statusSpan.className = 'status-indicator status-priority';
                } else if (rating === 'interesting') {
                    interestingBtn.classList.add('active');
                    statusSpan.textContent = '👍 Цікаво';
                    statusSpan.className = 'status-indicator status-interesting';
                } else if (rating === 'not-interesting') {
                    notInterestingBtn.classList.add('active');
                    statusSpan.textContent = '👎 Не цікаво';
                    statusSpan.className = 'status-indicator status-not-interesting';
                } else {
                    statusSpan.textContent = '🤔 Не оцінено';
                    statusSpan.className = 'status-indicator status-neutral';
                }
            } catch (error) {
                console.error('Помилка оновлення рейтингу для carId:', carId, error);
            }
        }

        // Генерація таблиці
        function generateTable() {
            try {
                const tbody = document.getElementById('carTable');
                if (!tbody) {
                    console.error('Не знайдений елемент carTable');
                    return;
                }
                
                tbody.innerHTML = '';

                carsData.forEach((car, index) => {
                    if (!car || !car.id) {
                        console.warn('Некоректні дані автомобіля:', car);
                        return;
                    }

                    const rating = carRatings[car.id] || '';
                    const comment = carComments[car.id] || '';
                    const isSelected = selectedCars.has(car.id);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" 
                                class="select-checkbox" 
                                ${isSelected ? 'checked' : ''}
                                onchange="toggleCarSelection('${car.id}')"
                            >
                        </td>
                        <td>${index + 1}</td>
                        <td>
                            <input 
                                type="text" 
                                class="editable-input brand-model-input" 
                                value="${(car.brand || '').replace(/"/g, '&quot;')}"
                                onchange="updateCarData('${car.id}', 'brand', this.value)"
                                placeholder="Марка/Модель"
                            >
                        </td>
                        <td>
                            <input 
                                type="text" 
                                class="editable-input" 
                                value="${(car.type || '').replace(/"/g, '&quot;')}"
                                onchange="updateCarData('${car.id}', 'type', this.value)"
                                placeholder="Тип двигуна"
                            >
                        </td>
                        <td>
                            <input 
                                type="text" 
                                class="editable-input mileage-input" 
                                value="${(car.mileage || '').replace(/"/g, '&quot;')}"
                                onchange="updateCarData('${car.id}', 'mileage', this.value)"
                                placeholder="Пробіг"
                            >
                        </td>
                        <td>
                            <input 
                                type="text" 
                                class="editable-input price-input" 
                                value="${(car.price || '').replace(/"/g, '&quot;')}"
                                onchange="updateCarData('${car.id}', 'price', this.value)"
                                placeholder="Ціна"
                            >
                        </td>
                        <td>
                            <input 
                                type="text" 
                                class="editable-input features-input" 
                                value="${(car.features || '').replace(/"/g, '&quot;')}"
                                onchange="updateCarData('${car.id}', 'features', this.value)"
                                placeholder="Особливості"
                            >
                        </td>
                        <td class="rating-cell">
                            <div class="rating-buttons">
                                <button class="rating-btn priority-btn" id="priority-${car.id}" onclick="rateCar('${car.id}', 'priority')" title="Топ пріоритет">🏆</button>
                                <button class="rating-btn interesting-btn" id="interesting-${car.id}" onclick="rateCar('${car.id}', 'interesting')" title="Цікаво">👍</button>
                                <button class="rating-btn not-interesting-btn" id="not-interesting-${car.id}" onclick="rateCar('${car.id}', 'not-interesting')" title="Не цікаво">👎</button>
                            </div>
                            <span class="status-indicator status-neutral" id="status-${car.id}">🤔 Не оцінено</span>
                        </td>
                        <td class="comment-cell">
                            <button class="template-btn" onclick="showCommentTemplates(this.nextElementSibling)">📝</button>
                            <textarea 
                                class="comment-input" 
                                placeholder="Додайте свій коментар..."
                                oninput="updateComment('${car.id}', this.value)"
                                data-car-id="${car.id}"
                            >${comment.replace(/"/g, '&quot;')}</textarea>
                        </td>
                        <td class="link-cell">
                            <a href="${car.url || '#'}" target="_blank">Переглянути оголошення</a>
                        </td>
                        <td class="actions-cell">
                            <button class="delete-btn" onclick="deleteCar('${car.id}')" title="Видалити">🗑️</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                    
                    // Оновлення відображення оцінки з затримкою
                    setTimeout(() => updateRatingDisplay(car.id), 100);
                });
                
                console.log('Таблиця згенерована успішно, автомобілів:', carsData.length);
            } catch (error) {
                console.error('Помилка генерації таблиці:', error);
            }
        }

        // Ініціалізація додатку
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Ініціалізація додатку...');
            console.log('Початкових автомобілів:', carsData.length);
            
            // Спочатку показуємо початкові дані
            generateTable();
            updateStats();
            
            // Ініціалізуємо обробник вставки
            smartPasteHandler();
            
            // Потім завантажуємо збережені дані
            await loadSavedData();
            
            // Оновлюємо таблицю після завантаження
            generateTable();
            updateStats();
            
            console.log('✅ Додаток ініціалізовано успішно з Firebase підтримкою');
            console.log('Фінальна кількість автомобілів:', carsData.length);
        });
    </script>
</body>
</html>
